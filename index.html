<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор КП</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); padding: 20px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .row input { width: 45%; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .add-btn { background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); }
        .del-btn { background-color: #ff3b30; color: white; width: 40px; padding: 10px; }
        #main-btn { background-color: #28a745; color: white; font-weight: bold; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <h3>Новое КП</h3>
    <input type="text" id="objectName" placeholder="Название объекта (напр. Парк Балашиха)">
    
    <h4>Позиции:</h4>
    <div id="items-container">
        </div>

    <button class="add-btn" onclick="addItem()">+ Добавить металл</button>
    <br>
    
    <div style="margin-top: 20px;">
        <label><input type="checkbox" id="painting" style="width:auto;"> Грунтовка ГФ-021</label><br>
        <label><input type="checkbox" id="delivery" style="width:auto;"> Доставка</label>
    </div>

    <button id="main-btn" onclick="sendData()">СФОРМИРОВАТЬ PDF</button>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand(); // Раскрыть на весь экран

        // Список металлов для выбора
        const metalTypes = ["Балка", "Труба проф.", "Лист", "Швеллер", "Уголок"];

        function addItem() {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.className = 'row';

            // Создаем выпадающий список
            let selectHTML = '<select class="metal-type">';
            metalTypes.forEach(m => selectHTML += `<option value="${m}">${m}</option>`);
            selectHTML += '</select>';

            div.innerHTML = `
                ${selectHTML}
                <input type="number" class="metal-weight" placeholder="Тонн" step="0.1">
                <button class="del-btn" onclick="this.parentElement.remove(); checkButton()">X</button>
            `;
            container.appendChild(div);
            checkButton();
        }

        function checkButton() {
            // Показываем кнопку "Отправить" только если есть позиции
            const count = document.getElementsByClassName('row').length;
            document.getElementById('main-btn').style.display = count > 0 ? 'block' : 'none';
        }

        function sendData() {
            const objName = document.getElementById('objectName').value;
            if (!objName) {
                tg.showPopup({title: 'Ошибка', message: 'Введите название объекта!'});
                return;
            }

            let items = [];
            document.querySelectorAll('.row').forEach(row => {
                items.push({
                    type: row.querySelector('.metal-type').value,
                    weight: parseFloat(row.querySelector('.metal-weight').value) || 0
                });
            });

            const data = {
                object_name: objName,
                items: items,
                painting: document.getElementById('painting').checked,
                delivery: document.getElementById('delivery').checked
            };

            // Отправляем данные боту
            tg.sendData(JSON.stringify(data)); 
        }

        // Добавляем первую строку сразу при загрузке
        addItem();
    </script>
</body>
</html>